<apex:page Controller="OpportunityReportController" id="pg">
    <apex:form rendered="{!NOT(isAllowed)}">
<apex:outputlabel value="You are not authorized to access this report." style="color:#cc0000;font-weight:Bold;font-weight:24px"/>
</apex:form>
    <apex:form rendered="{!isAllowed}" id="frm">
            <script> 
function openWindowforEmail(){   
     window.open('SendEmailOppReport', "SendEmailWindow","menubar=0,resizable=1,scroll=1,width=620,height=380");   
}
function test(to, cc, bcc, subject, body){
    //alert(to);
      //  alert(cc);
        //    alert(bcc);
            document.getElementById("pg:frm:pb:touser").value=to;
            document.getElementById("pg:frm:pb:ccuser").value=cc;
            document.getElementById("pg:frm:pb:bccuser").value=bcc;
            document.getElementById("pg:frm:pb:subject").value=subject;
            document.getElementById("pg:frm:pb:body").value=body;
            
   SendMail1();
   return false;
}
</script>
        <apex:pageMessages />
        <apex:pageBlock id="pb">
        <apex:actionFunction action="{!exportToPDFAndEmail}" name="SendMail1"/>
        <apex:inputHidden value="{!sendEmailToUser}" id="touser" />
        <apex:inputHidden value="{!strEmailDealerCC}" id="ccuser" />
        <apex:inputHidden value="{!strEmailDealerBcc}" id="bccuser" />
        <apex:inputHidden value="{!MAIL_SUBJECT}" id="subject" />
        <apex:inputHidden value="{!strEmailBody}" id="body" />
            <apex:pageBlockSection title="Report Filters" columns="10">
                <apex:outputLabel value="{!$ObjectType.opportunity.fields.Business_Unit__c.label}"
                    for="bu" style="font-weight:bold;width:25%" />
                <apex:selectList value="{!busiUnits}" multiselect="true" size="5"
                    id="bu">
                    <apex:selectOptions value="{!listBusiUnits}" />
                </apex:selectList>
                <!-- Case#00063588 replaced Region1__c with Country__c -->
                <apex:outputLabel value="{!$ObjectType.opportunity.fields.Country__c.label}"
                    for="region" style="font-weight:bold;width:25%" />
                <apex:selectList value="{!regions}" multiselect="true" size="5"
                    id="region">
                    <apex:selectOptions value="{!listRegion}" />
                </apex:selectList>
                <apex:outputLabel value="{!$ObjectType.opportunity.fields.Sub_Region__c.label}"
                    for="subregion" style="font-weight:bold;width:25%" />
                <apex:selectList value="{!subRegions}" multiselect="true" size="5"
                    id="subregion">
                    <apex:selectOptions value="{!listSubRegion}" />
                </apex:selectList>
                <apex:outputLabel value="{!$ObjectType.opportunity.fields.stageName.label}"
                    for="stage" style="font-weight:bold;width:25%" />
                <apex:selectList value="{!salesStages}" multiselect="true" size="5"
                    id="stage">
                    <apex:selectOptions value="{!listSalesStage}" />
                </apex:selectList>
                <apex:outputLabel value="{!$ObjectType.opportunity.fields.Probability.label}"
                    for="prob" style="font-weight:bold;width:25%" />
                <apex:selectList value="{!probs}" multiselect="true" size="5"
                    id="prob">
                    <apex:selectOptions value="{!listProb}" />
                </apex:selectList>
                <apex:commandButton value="Run" action="{!getData}"
                    rerender="theReportTable, statusPanel" status="siteStatus" />
            </apex:pageBlockSection>
        </apex:pageBlock>
        <apex:outputPanel >
            <apex:actionStatus startText="Fetching Data. Please Wait...."
                id="siteStatus"
                startStyle="color:#cc0000;font-weight:Bold;font-weight:24px" />
        </apex:outputPanel>
        <apex:outputPanel id="statusPanel">            
             <apex:outputText value="{!message2}" Style="color:#cc0000;font-weight:Bold;font-weight:24px"/>
        </apex:outputPanel>
       
        <apex:outputPanel id="theReportTable">
            <apex:pageBlock title="Opportunity Report" rendered="{!show}">
                <apex:pageBlockButtons >
                    <apex:commandLink value="Export to Excel"
                        action="{!exportToExcel}"  target="_blank" styleClass="btn"/>
                    <apex:commandLink value="Export to PDF" action="{!exportToPDF}"  target="_blank" styleClass="btn"/>
                    <apex:commandLink value="Export to PDF and Email" onclick="openWindowforEmail(); return false;"  styleClass="btn"/>
                </apex:pageBlockButtons>
				<apex:pageBlockTable value="{!listOppRep}" var="opp" border="1">
				<apex:column >
					<apex:facet name="header">S.<br/>No.</apex:facet>
					<apex:outputText value="{!opp.Id}" />
				</apex:column>
				<apex:column >
					<apex:facet name="header">Opportunity Name</apex:facet>
					<a href="/{!opp.innerOpp.Id}" target="_blank"><apex:outputField value="{!opp.innerOpp.Name}" rendered="{!opp.show}"/></a>
					<b><apex:outputField value="{!opp.innerOpp.Sub_Region__c}" rendered="{!NOT(opp.show)}"/></b> 
				</apex:column>
				<apex:column >
					<apex:facet name="header">Site City</apex:facet>
					<apex:outputText value="{!opp.Muncipality}"  rendered="{!opp.show}"/>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Sales Stage</apex:facet>
					<apex:outputField value="{!opp.innerOpp.StageName}" rendered="{!opp.show}"/>
					<apex:facet name="footer"><B>Total System Size(PV):</B></apex:facet>
					<apex:outputText value="{!opp.innerOpp.StageName}" rendered="{!NOT(opp.show)}" styleClass="totalRow" />
				</apex:column>
				<apex:column >
					<apex:facet name="header">Probability</apex:facet>
					<apex:outputField value="{!opp.innerOpp.Probability}" rendered="{!opp.show}"/>					
				</apex:column>
				<apex:column >
					<apex:facet name="header">System Size<br/>(PV)</apex:facet>
					<apex:outputField value="{!opp.innerOpp.System_SizePV__c}" rendered="{!opp.show}"/>
					<b><apex:outputField value="{!opp.innerOpp.System_Size_PV_Report__c}" rendered="{!NOT(opp.show)}"/></b>
					<apex:facet name="footer"><apex:outputField value="{!sumOppCapacity.System_Size_PV_Report__c}"/></apex:facet>
				</apex:column>
				<apex:column >
					<apex:facet name="header">% Of Useable <br/>Land (Average)</apex:facet>
					<apex:outputField value="{!opp.innerOpp.Average_Usable_Land_Percentage__c}"  rendered="{!opp.show}"/>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Date Land <br/>Option</apex:facet>
					<apex:outputPanel style="color:{!opp.Land_Option_Color};">
						<apex:outputField value="{!opp.innerOpp.Binding_Offer_Accepted_Date__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Interconnection <br/>Request Filed</apex:facet>
					<apex:outputPanel style="color:{!opp.STMG_Req_Filed_Color};">
						<apex:outputField value="{!opp.innerOpp.Account.Interconnection_Request_Filed__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Phase I Study <br/>Received</apex:facet>
					<apex:outputPanel style="color:{!opp.STMG_Receiving_Color};">
						<apex:outputField value="{!opp.innerOpp.Account.Phase_I_Study_Received__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Phase I Study <br/>Accepted</apex:facet>
					<apex:outputPanel style="color:{!opp.STMG_Accepted_Color};">
						<apex:outputField value="{!opp.innerOpp.Account.Phase_I_Study_Accepted__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Permit <br/>Submitted</apex:facet>
					<apex:outputPanel style="color:{!opp.Autho_Req_Filed_Color};">
						<apex:outputField value="{!opp.innerOpp.Permit_Submitted__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Next Meeting <br/>with Authorities</apex:facet>
					<apex:outputPanel style="color:{!opp.First_Call_CDS_Color};">
						<apex:outputField value="{!opp.innerOpp.Next_Meeting_with_Authorities__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Environmental <br/>Request Filed</apex:facet>
					<apex:outputPanel style="color:{!opp.VIA_Req_Filed_Color};">
						<apex:outputField value="{!opp.innerOpp.Environmental_Request_Filed__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Environmental <br/>Request Approved</apex:facet>
					<apex:outputPanel style="color:{!opp.VIA_Approval_Color};">
						<apex:outputField value="{!opp.innerOpp.Environmental_Request_Approved__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Appeal Period <br />Start Date</apex:facet>
					<apex:outputPanel style="color:{!opp.Appeal_Period_Start_Color};">
						<apex:outputField value="{!opp.innerOpp.Appeal_Period_Start_Date__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Appeal Period <br />End Date</apex:facet>
					<apex:outputPanel style="color:{!opp.Appeal_Period_End_Color};">
						<apex:outputField value="{!opp.innerOpp.Appeal_Period_End_Date__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Phase II Study <br/>Filed</apex:facet>
					<apex:outputPanel style="color:{!opp.STMD_Req_Filed_Color};">
						<apex:outputField value="{!opp.innerOpp.Phase_II_Study_Filed1__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Phase II Study <br/>Received</apex:facet>
					<apex:outputPanel style="color:{!opp.STMD_Receiving_Color};">
						<apex:outputField value="{!opp.innerOpp.Phase_II_Study_Received1__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Phase II Study <br/>Accepted</apex:facet>
					<apex:outputPanel style="color:{!opp.STMD_Accepted_Color};">
						<apex:outputField value="{!opp.innerOpp.Phase_II_Study_Accepted1__c}"  rendered="{!opp.show}"/>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Land Expiry</apex:facet>
					<apex:outputPanel style="color:{!opp.Land_Expiry_Color};" rendered="{!opp.show}">
						<apex:outputLink value="/{!opp.siteId}" target="_blank" style="color:{!opp.Land_Expiry_Color};" rendered="{!NOT(opp.siteId==null || opp.siteId=='')}">
							<apex:outputField value="{!opp.innerOpp.X75_Meeting_Date__c}"/>
						</apex:outputLink>
					</apex:outputPanel>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Mounting <br/>System</apex:facet>
					<apex:outputText value="{!opp.Technology}"  rendered="{!opp.show}"/>
				</apex:column>
				<apex:column >
					<apex:facet name="header">PV <br/>Modules</apex:facet>
					<apex:outputText value="{!opp.Modules}"  rendered="{!opp.show}"/>
				</apex:column>
				<apex:column >
					<apex:facet name="header">Total Land Size</apex:facet>
					<apex:outputField value="{!opp.innerOpp.Total_Land_Size__c}" rendered="{!opp.show}"/>
					<b><apex:outputField value="{!opp.innerOpp.Total_Land_Size__c}" rendered="{!NOT(opp.show)}"/></b>
				</apex:column>								
			</apex:pageBlockTable>
			<apex:outputLabel value="Total Opportunities:                                         {!countOpp}" styleClass="totalRow" />
			<br/>
            <apex:outputLabel value="{!message}" />    
            </apex:pageBlock>
        </apex:outputPanel>
    </apex:form>
</apex:page>