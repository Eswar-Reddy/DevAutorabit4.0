<apex:page controller="LiveChatOfflineController" showHeader="false" language="{!language}">
    <script type="text/javascript">
        var __sfdcSessionId = '{!sessionId}';
    </script>
    
    <script src="../../soap/ajax/34.0/connection.js" type="text/javascript"></script>
    <script type='text/javascript' src='https://{!deploymentHostName}.salesforceliveagent.com/content/g/js/37.0/prechat.js'></script>
    <apex:includeScript value="{!URLFOR($Resource.jquery_1_11_3)}"/>
    
    <script type='text/javascript'>
        var j$ = jQuery.noConflict();
    </script>

    <apex:outputPanel id="paramRefreshPanel">
    <script type='text/javascript'>
        var isAvailable = {!isAvailable};
        if (isAvailable == false) {
            document.getElementById("notAvailableDiv").style.display = "block";
            document.getElementById("availableDiv").style.display = "none";
        } else {
            document.getElementById("notAvailableDiv").style.display = "none";
            document.getElementById("availableDiv").style.display = "block";
        }
    </script>
    </apex:outputPanel>
    
    <script type="text/javascript">
        var deployment_id, button_id;
        var detailCallback = function (details) { 
            for (var i = 0; i < details.customDetails.length; i++) {
                myLog(details.customDetails[i].label + '/' + details.customDetails[i].value);
                if (details.customDetails[i].label == 'deployment_id') {
                    deployment_id = details.customDetails[i].value;
                } else if (details.customDetails[i].label == 'button_id') {
                    button_id = details.customDetails[i].value;
                }
            }
            setCustomDetails(deployment_id, button_id);
        };
        liveagent.details.preChatInit('https://{!preChatHostName}.salesforceliveagent.com/chat', 'detailCallback');

        (function() {
            function handlePageLoad() {
                var endpointMatcher = new RegExp("[\\?\\&]endpoint=([^&#]*)");
                document.getElementById('prechatForm').setAttribute('action',
                decodeURIComponent(endpointMatcher.exec(document.location.search)[1]));
            }
            if (window.addEventListener) {
                window.addEventListener('load', handlePageLoad, false);
            } else {
                window.attachEvent('onload', handlePageLoad, false);
            }
        })();
        
        function setName(){
            var firstName = document.getElementById("customField1").value;
            var lastName = document.getElementById("customField2").value;
            var emailAddress = document.getElementById("customField3").value;
            var firstNameTrim = myTrim(firstName);
            var lastNameTrim = myTrim(lastName);
            var emailAddressTrim = myTrim(emailAddress);
            if (firstNameTrim != "") {
                document.getElementById("windowName").value = firstNameTrim + " " + lastNameTrim;
            } else if (lastNameTrim != "") {
                document.getElementById("windowName").value = lastNameTrim;
            } else if (emailAddressTrim != "") {
                document.getElementById("windowName").value = emailAddressTrim;
            }
        }
        
        function validateMyForm() {
            myLog('isAvailable: ' + isAvailable);
            if (isAvailable == true) {
                setName();
                return true;
            } else {
                var emailAddress = document.getElementById("customField3").value;
                var phoneNumber = document.getElementById("customField4").value;
                var errMsg = "";
                if (!myTrim(emailAddress)) {
                    errMsg = "Email Address is required.";
                }
                if (!myTrim(phoneNumber)) {
                    if (myTrim(errMsg)) {
                        errMsg = errMsg + "\n" + "Phone Number is required.";
                    } else {
                        errMsg = "Phone Number is required.";
                    }
                }
                if (myTrim(errMsg)) {
                    alert(errMsg);
                } else {
                    var visitor = new sforce.SObject("LiveChatVisitor");
                    sforce.connection.create([visitor], {onSuccess : visitorSuccess, onFailure : visitorFailure});
                    document.getElementById("prechatDiv").style.display = "none";
                    document.getElementById("closeWindowDiv").style.display = "block";
                }
                return false;
            }
        }

        function visitorSuccess(result) {
            if (result[0].getBoolean("success")) {
                myLog("new visitor created with id " + result[0].id);

                var transcript = new sforce.SObject("LiveChatTranscript");
                transcript.Status = "Missed";
                transcript.LiveChatVisitorId = result[0].id;
                transcript.LiveChatButtonId = button_id;
                transcript.First_Name__c = document.getElementById("customField1").value;
                transcript.Last_Name__c = document.getElementById("customField2").value;
                transcript.Email_Address__c = document.getElementById("customField3").value;
                transcript.Phone_Number__c = document.getElementById("customField4").value;
                transcript.Case_Number__c = document.getElementById("customField6").value;
                transcript.How_can_we_help_you__c = document.getElementById("customField7").value;
                var relatedToSelector = document.querySelector('input[name = "liveagent.prechat:RelatedTo"]:checked');
                if (relatedToSelector != null) {
                    transcript.Related_To__c = relatedToSelector.value;
                }
                transcript.RequestTime = new Date().toISOString();
                if (window.navigator) {
                    if (window.navigator.userAgent) {
                        transcript.UserAgent = window.navigator.userAgent.substring(0,200);
                    }
                    if (window.navigator.platform) {
                        transcript.Platform = window.navigator.platform.substring(0,200);
                    }
                    if (window.navigator.language) {
                        transcript.BrowserLanguage = window.navigator.language.substring(0,200);
                    }
                    
                    window.navigator.sayswho = (function(){
                        var ua = navigator.userAgent, tem,
                        M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
                        if(/trident/i.test(M[1])){
                            tem =  /\brv[ :]+(\d+)/g.exec(ua) || [];
                            return 'IE '+(tem[1] || '');
                        }
                        if(M[1] === 'Chrome'){
                            tem = ua.match(/\b(OPR|Edge)\/(\d+)/);
                            if(tem != null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
                        }
                        M = M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
                        if((tem = ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
                        return M.join(' ');
                    })();
                    if (window.navigator.sayswho) {
                        transcript.Browser = window.navigator.sayswho.substring(0,200);
                    }
                    
                }
                var w = window.outerWidth || document.documentElement.clientWidth || document.body.clientWidth;
                var h = window.outerHeight || document.documentElement.clientHeight || document.body.clientHeight;
                transcript.ScreenResolution = (w + 'x' + h).substring(0,200);
                
                if ({!getVisitorLocation}) {
                    j$.getJSON('https://geoip-db.com/json/geoip.php?jsonp=?', function(location) {
                        myLog(location);
                        if (location) {
                            if (location.IPv4) {
                                transcript.IpAddress = location.IPv4;
                            }
                            transcript.Location = location.city + ', ' + location.state + ', ' + location.country_name;
                        }
                        sforce.connection.create([transcript], {onSuccess : transcriptSuccess, onFailure : transcriptFailure});
                    });
                } else {
                    sforce.connection.create([transcript], {onSuccess : transcriptSuccess, onFailure : transcriptFailure});
                }
                
            } else {
                alert("Failed to create visitor " + result[0]);
            }
        }
        
        function visitorFailure(error) {
            alert("Error while creating visitor " + error);
        }

        function transcriptSuccess(result) {
            if (result[0].getBoolean("success")) {
                myLog("new transcript created with id " + result[0].id);
            } else {
                alert("Failed to create transcript " + result[0]);
            }
        }
        
        function transcriptFailure(error) {
            alert("Error while creating transcript " + error);
        }
        
        function myTrim(x) {
            return x.replace(/^\s+|\s+$/gm,'');
        }

        function myLog(value) {
            if (window.console && window.console.log) window.console.log(value);
        }
    
    </script>
    
    <apex:pagemessages ></apex:pagemessages> 
    
    <apex:form >
        <apex:actionFunction name="setCustomDetails" action="{!setCustomDetails}" reRender="debug,paramRefreshPanel,chatWithMsgPanel">
            <apex:param name="deployment_id" value=""/>
            <apex:param name="button_id" value=""/>
        </apex:actionFunction>
    </apex:form>
    
    <div id="prechatDiv">   
    <form method='post' id='prechatForm' onsubmit="return validateMyForm();">
        <div class="center">
        
        <table>
            <tr>
                <td align="center">
                    <c:LiveChatSunpowerImage />
                </td>
            </tr>
        </table>

        <apex:outputPanel id="chatWithMsgPanel">
        <div id="availableDiv" style="display:none">
        <apex:outputPanel rendered="{!isAvailable}">
        <table align="center">
            <tr>
                <td>{!$Label.Live_Chat_Survey_Chat_with_CSR}</td>
            </tr>
        </table>
        </apex:outputPanel>
        </div>
        <div id="notAvailableDiv" style="display:none">
        <apex:outputPanel style="font-color:red" rendered="{!NOT(isAvailable)}">
        <table align="center">
            <tr>
                <td align="center" style="color:red">{!$Label.Live_Chat_Survey_Offline_Message_1}</td>
            </tr>
            <tr>
                <td align="center" style="color:red">{!$Label.Live_Chat_Survey_Offline_Message_2}</td>
            </tr>
        </table>
        </apex:outputPanel>
        </div>
        </apex:outputPanel>

        <div style="height:40px"></div>
        <table>
            <tr>
                <td style="width:100px">{!$Label.Live_Chat_Survey_First_Name}</td>
                <td><input type='text' name='liveagent.prechat:FirstNameDetail' id='customField1' style="width:300px"/></td>
            </tr>
            <tr>
                <td>{!$Label.Live_Chat_Survey_Last_Name}</td>
                <td><input type='text' name='liveagent.prechat:LastNameDetail' id='customField2' style="width:300px"/></td>
            </tr>
            <tr>
                <td>{!$Label.Live_Chat_Survey_E_mail_Address}</td>
                <td><input type='text' name='liveagent.prechat:EmailAddress' id='customField3' style="width:300px"/></td>
            </tr>
            <tr>
                <td>{!$Label.Live_Chat_Survey_Phone_Number}</td>
                <td><input type='text' name='liveagent.prechat:PhoneNumber' id='customField4' style="width:300px"/></td>
            </tr>
            <tr>
                <td>{!$Label.Live_Chat_Survey_Case_Number}</td>
                <td><input type='text' name='liveagent.prechat:CaseNumber' id='customField6' style="width:100px"/></td>
            </tr>
            <tr>
                <td>
                    <input type="radio" name="liveagent.prechat:RelatedTo" value="Lease"/>Lease<br/>
                    <input type="radio" name="liveagent.prechat:RelatedTo" value="Purchase"/>Purchase<br/>
                    <input type="radio" name="liveagent.prechat:RelatedTo" value="Other"/>Other
                    
                </td>
            </tr>
        </table>
        
        <table>
            <tr>
                <td>{!$Label.Live_Chat_Survey_How_can_we_help_you}</td>
                <td></td>
            </tr>
                <td><textarea name='liveagent.prechat:HowCanWeHelpYou' id='customField7' style='width:300px;height:50px'/></td>
                <td><input type='submit' value='Submit' id='prechat_submit'/></td>
            <tr>
            
            </tr>
        </table>
        
        </div>

        <input type="hidden" name="liveagent.prechat.findorcreate.map:Contact" value="FirstName,FirstNameDetail;LastName,LastNameDetail;Email,EmailAddress" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map:Lead" value="FirstName,FirstNameDetail;LastName,LastNameDetail;Email,EmailAddress" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map:Account" value="FirstName,FirstNameDetail;LastName,LastNameDetail;Email__c,EmailAddress" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map:Case" value="CaseNumber,CaseNumber" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map.doFind:Contact" value="Email,true" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map.doFind:Lead" value="Email,true" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map.doFind:Account" value="Email__c,true" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map.doFind:Case" value="CaseNumber,true" />
        <input type="hidden" name="liveagent.prechat.findorcreate.map.isExactMatch:Contact" value="Email,true" />
        
        <input type="hidden" name="liveagent.prechat.name" id='windowName' />
        
        <input type="hidden" name="liveagent.prechat.save:FirstNameDetail" value="First_Name__c" />
        <input type="hidden" name="liveagent.prechat.save:LastNameDetail" value="Last_Name__c" />
        <input type="hidden" name="liveagent.prechat.save:EmailAddress" value="Email_Address__c" />
        <input type="hidden" name="liveagent.prechat.save:PhoneNumber" value="Phone_Number__c" />
        <input type="hidden" name="liveagent.prechat.save:CaseNumber" value="Case_Number__c" />
        <input type="hidden" name="liveagent.prechat.save:RelatedTo" value="Related_To__c" />
        <input type="hidden" name="liveagent.prechat.save:HowCanWeHelpYou" value="How_can_we_help_you__c" />
        
        <style type="text/css">
            .center {
                margin: 5px;
                border:1px solid black;
                padding: 5px;
            }
        </style>
    </form>
    </div>

    <div id="closeWindowDiv" style="display:none">   
        <table>
            <tr>
                <td align="center">
                    <c:LiveChatSunpowerImage />
                </td>
            </tr>
            <tr>
                <td align="center">Thank you for submitting your details.</td>
            </tr>
            <tr>
                <td align="center">
                    <apex:outputLink onclick="window.close();return false">
                        {!$Label.Live_Chat_Survey_close_window}
                    </apex:outputLink>
                </td>
            </tr>
        </table>
    </div>
    
    <apex:pageBlock title="Debug" rendered="{!showDebug}" id="debug">
        liveAgentAPIEndpoint: {!liveAgentAPIEndpoint} <br/>
        org_id: {!org_id} <br/>
        deployment_id: {!deployment_id} <br/>
        button_id: {!button_id} <br/>
        deploymentHostName: {!deploymentHostName} <br/>
        preChatHostName: {!preChatHostName} <br/>
        isNotBlankSessionId: {!isNotBlankSessionId} <br/>
        availabilityStatus: {!availabilityStatus} <br/>
        availabilityStatusCode: {!availabilityStatus} <br/>
        availabilityRequestBody: {!availabilityRequestBody} <br/>
        availabilityMessages: {!availabilityMessages} <br/>
        availabilityType: {!availabilityType} <br/>
        isAvailable: {!isAvailable} <br/>
        getVisitorLocation: {!getVisitorLocation} <br/>
        
    </apex:pageBlock>
</apex:page>