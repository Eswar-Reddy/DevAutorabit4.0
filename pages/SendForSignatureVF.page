<apex:page showHeader="false" sidebar="false" StandardController="echosign_dev1__SIGN_Agreement__c" extensions="SendForSignatureVfController">
    <apex:messages id="showmsg"></apex:messages>
    <body>
        <div name="waitImageDiv" align="center" top="50%"> 
            <apex:image id="waitTimeImage" value="/img/waiting_dots.gif" alt="Please wait..." title="Please wait..." height="20" width="196"/>
            <h2>Please wait... sending agreement</h2> 
        </div>
        <apex:form >
            
            <apex:actionFunction name="showPageMessage" action="{!showPageMessage}">
                <apex:param name="level" assignTo="{!level}" value="122" />
                <apex:param name="message" assignTo="{!message}" value="111" />
            </apex:actionFunction>
        </apex:form>
        <script src="/soap/ajax/35.0/connection.js" type="text/javascript"></script>
        <script src="/soap/ajax/35.0/apex.js" type="text/javascript"></script>
        <script type="text/javascript">
        sforce.connection.sessionId = '{!$Api.Session_ID}';
        </script>
        
        
        <script type="text/javascript">
        
        window.onload = function(){
            startMethodCallToGetEcoSignId();
        }
        
        
        function startMethodCallToGetEcoSignId() { 
            var param2="{!echosign_dev1__SIGN_Agreement__c.Id}";
            mappingAllFieldsAndMakeAPICall(param2); 
            
        } 
        
        function mappingAllFieldsAndMakeAPICall(retUrl) {
            var c = new sforce.SObject("echosign_dev1__SIGN_Agreement__c"); 
            retUrl=retUrl.substring(0,15);
            c.id = retUrl;
            
            c.echosign_dev1__ErrorMessage__c=null;
            result1 = sforce.connection.update([c]);
            
            c.echosign_dev1__Background_Action__c='Send'; 
            c.echosign_dev1__Status__c='Out for Signature';
            
            var recipientEmail='{!recipientMail}';
            var addRecipient1EMail='{!recipient1Mail}';
            var addRecipient2Email='{!recipient2Mail}';
            var addEmail='{!addEmail}';
            
            var sendFinalEmail='';
            if(recipientEmail !=null && recipientEmail !=''){
                sendFinalEmail=sendFinalEmail+recipientEmail;
                
            }
            
            if(addRecipient1EMail !=null && addRecipient1EMail !=''){
                sendFinalEmail=sendFinalEmail+','+addRecipient1EMail;
                
            }
            
            if(addRecipient2Email !=null && addRecipient2Email !=''){
                sendFinalEmail=sendFinalEmail+','+addRecipient2Email;
                
            }
            
            if(addEmail !=null  && addEmail !=''){
                sendFinalEmail=sendFinalEmail+','+addEmail ; 
            }
            
            c.echosign_dev1__Recipient_Addresses__c=sendFinalEmail;
            
            result = sforce.connection.update([c]); 
            var getUrl = window.location.origin;
            
            if (result[0].success === "false"){
                alert(result[0].errors.message);
                c.echosign_dev1__Status__c='Draft';
                result = sforce.connection.update([c]); 
                showPageMessage('Error',result[0].errors.message);
                
            }
            else{
                setTimeout( function() {
                    if(window.opener !=null){
                        window.opener.location.href ='/'+retUrl; 
                        window.close(); }
                    else{
                        window.open(getUrl+'/'+retUrl,"_self");
                    }
                }, 1800);
                
            } 
            
        } 
        </script>
    </body>
</apex:page>